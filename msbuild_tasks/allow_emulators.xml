<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <UsingTask
      TaskName="ModifyRegistry"
      TaskFactory="RoslynCodeTaskFactory"
      AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll" >
      <ParameterGroup />
      <Task>
        <Using Namespace="System.Text"/>
        <Using Namespace="System.Runtime.InteropServices"/>
        <Code Type="Method" Language="cs">
          <![CDATA[
            [DllImport("advapi32.dll", CharSet = CharSet.Auto)]
            private static extern int RegOpenKeyEx(
              UIntPtr hKey,
              string subKey,
              int ulOptions,
              int samDesired,
              out UIntPtr hkResult);

            [DllImport("advapi32.dll", CharSet = CharSet.Unicode, SetLastError = true)]
            private static extern int RegSetValueEx(
              UIntPtr hKey,
              string lpValueName,
              int Reserved,
              uint dwType,
              byte[] lpData,
              uint cbData);

            [DllImport("advapi32.dll", CharSet = CharSet.Unicode, SetLastError = true)]
            private static extern int RegDeleteValue(
              UIntPtr hKey,
              string lpValueName);

            private static UIntPtr HKLM = new UIntPtr(0x80000002u);
            private static int KEY_ALL_ACCESS = 0xF003F;

            public override bool Execute()
            {
              UIntPtr hKey;
              if (RegOpenKeyEx(HKLM, "OSDATA\\Software\\Microsoft\\Durango\\LiveSettings", 0, KEY_ALL_ACCESS, out hKey) == 0)
              {
                // Set "BlockEmulatorsEnabled" to 0
                byte[] value = BitConverter.GetBytes(0);
                if (RegSetValueEx(hKey, "BlockEmulatorsEnabled", 0, 4, value, (uint)value.Length) != 0)
                {
                  Console.WriteLine("Failed to set BlockEmulatorsEnabled");
                  return false;
                }

                // Remove other keys
                string[] keysToRemove = new string[] {
                  "BlockEmulatorsRestrictedExeSubstrings",
                  "BlockEmulatorsLogOnlyExeSubstrings",
                  "BlockEmulatorPublisherPackageStrings"
                };
                foreach (string key in keysToRemove)
                {
                  if (RegDeleteValue(hKey, key) != 0)
                  {
                    Console.WriteLine("Failed to delete " + key);
                    return false;
                  }
                }

                Console.WriteLine("Registry modification successful");
                return true;
              }
              Console.WriteLine("Failed to open registry key");
              return false;
            }
          ]]>
        </Code>
      </Task>
    </UsingTask>
    <Target Name="ModifyRegistry">
      <ModifyRegistry />
    </Target>
  </Project>
